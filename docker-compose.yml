version: "3.8"

services:
    nats-server:
        image: nats:latest
        ports:
            - "4222:4222"
            - "8222:8222"
        networks:
            - nats-network

    auth-service-db:
        image: mongo:latest
        container_name: auth-service-db
        ports:
            - "27018:27017" # Maps external port 27018 to internal MongoDB port 27017
        environment:
            MONGO_INITDB_ROOT_USERNAME: root
            MONGO_INITDB_ROOT_PASSWORD: example
        volumes:
            - auth-service-db-data:/data/db
        networks:
            - auth-service-network

    auth-service:
        build: ./auth-service
        ports:
            - "3000:3000"
        environment:
            - NATS_URL=nats-server:4222
            - MONGO_URL=mongodb://root:example@auth-service-db:27017
            - JWT_SECRET=secret
        depends_on:
            - nats-server
            - auth-service-db
        networks:
            - auth-service-network
            - nats-network
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:3000/"]
            interval: 10s
            timeout: 5s
            retries: 5

volumes:
    auth-service-db-data:

networks:
    auth-service-network:
        driver: bridge
    nats-network:
        driver: bridge
    # express-service:
    #     build: ./express-service
    #     ports:
    #         - "3000:3000"
    #     environment:
    #         - NATS_URL=nats-server:4222
    #         - MONGO_URL=mongodb://root:example@mongo:27017
    #     depends_on:
    #         - nats-server
    #         - mongo
    #     healthcheck:
    #         test: ["CMD", "curl", "-f", "http://localhost:3000/"]
    #         interval: 10s
    #         timeout: 5s
    #         retries: 5

    # publisher-service:
    #     build: ./publisher-service
    #     environment:
    #         - NATS_URL=nats-server:4222
    #     depends_on:
    #         express-service:
    #             condition: service_healthy
